<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Dashboard</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="logout()">Cerrar Sesión</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- 
    Usamos `*ngIf="user$ | async as user"` para suscribirnos al observable del usuario.
    Todo el contenido solo se mostrará si el usuario ha iniciado sesión.
    La variable 'user' estará disponible para todos los elementos anidados.
  -->
  <ng-container *ngIf="user$ | async as user">
    
    <!-- Mensaje de bienvenida -->
    <ion-card class="welcome-card">
      <ion-card-header>
        <ion-card-title>Bienvenido, {{ user.email }}</ion-card-title>
      </ion-card-header>
    </ion-card>

    <!-- Mosaico de Categorías -->
    <ion-grid>
      <ion-row>
        <ion-col size="6" size-md="4" *ngFor="let cat of apiCategories">
          <ion-card class="category-card" (click)="selectApi(cat.value)" button>
            <ion-icon [name]="cat.icon"></ion-icon>
            <ion-card-header>
              <ion-card-subtitle>{{ cat.title }}</ion-card-subtitle>
            </ion-card-header>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>

    <!-- Componente para mostrar la API seleccionada -->
    <app-api-display *ngIf="selectedApi" [api]="selectedApi" [user]="user"></app-api-display>

    <!-- Lista de Favoritos -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Favoritos</ion-card-title>
      </ion-card-header>
      <!-- Usamos la pipe `async` para suscribirnos al observable de favoritos -->
      <ion-list *ngIf="(favorites$ | async) as favorites; else noFavorites">
        
        <!-- =============================================================== -->
        <!-- INICIO DE LA LÓGICA COMPLETA PARA MOSTRAR CADA FAVORITO -->
        <!-- =============================================================== -->
        <ion-item *ngFor="let fav of favorites">
          <ion-label>
            <h2>{{ fav.api | titlecase }}</h2>

            <!-- Para Chistes (incluyendo el formato del combo) -->
            <p *ngIf="fav.api === 'joke' || fav.api === 'combo'">{{ fav.joke?.joke || (fav.joke?.setup + ' - ' + fav.joke?.delivery) || (fav.setup + ' - ' + fav.delivery) }}</p>
            
            <!-- Para Citas -->
            <p *ngIf="fav.api === 'quote'">"{{ fav.content }}" - <em>{{ fav.author }}</em></p>
            
            <!-- Para Gatos -->
            <ion-img *ngIf="fav.api === 'cat'" [src]="fav.url"></ion-img>
            
            <!-- Para Perros -->
            <ion-img *ngIf="fav.api === 'dog'" [src]="fav.message"></ion-img>
            
            <!-- Para el animal del Combo -->
            <ion-img *ngIf="fav.api === 'combo'" [src]="fav.animal?.url || fav.animal?.message"></ion-img>
            
            <!-- Para Colores -->
            <ng-container *ngIf="fav.api === 'colors'">
              <h3>{{ fav.title }}</h3>
              <div class="color-swatch-favorite" [style.background-color]="'#' + fav.hex"></div>
              <p>HEX: #{{ fav.hex }}</p>
            </ng-container>

          </ion-label>
          <ion-button slot="end" color="danger" fill="clear" (click)="removeFavorite(fav.id)">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
        </ion-item>
        <!-- =============================================================== -->
        <!-- FIN DE LA LÓGICA COMPLETA PARA MOSTRAR CADA FAVORITO -->
        <!-- =============================================================== -->

      </ion-list>
      
      <!-- Template que se muestra si no hay favoritos -->
      <ng-template #noFavorites>
        <ion-card-content>
          <p>No tienes favoritos aún. Guarda algo desde arriba.</p>
        </ion-card-content>
      </ng-template>
    </ion-card>

  </ng-container> <!-- Fin del ng-container principal del usuario -->

</ion-content>